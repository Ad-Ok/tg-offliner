# TG-Offliner: Системный Аудит и Спецификация

## 📋 Цель документа

Этот документ описывает:
1. Все функции системы и их ожидаемое поведение
2. Текущий статус каждой функции (работает/сломано/частично)
3. Приоритеты исправления
4. План действий

---

## 🚨 ВЫЯВЛЕННЫЕ ПРОБЛЕМЫ (2 февраля 2026)

### Критические баги:

1. **Layouts галерей не загружаются при перезагрузке**
   - Причина: API не возвращал layouts с постами
   - Исправлено: добавлен layout в `api/posts.py` и `api/chunks.py`
   - Статус: ✅ Исправлено, требует тестирования

2. **Сортировка игнорирует URL параметр**
   - URL: `/llamasass/posts?chunk=0&sort_order=asc`
   - Симптом: показывает desc, надо 2 раза нажать кнопку
   - Статус: 🔴 Требует исследования

3. **PDF экспорт "ужасно выводится"**
   - Статус: 🔴 Требует исследования

4. **IDML экспорт "ужасно выводится"**
   - Статус: 🔴 Требует исследования

---

## 🎯 РЕКОМЕНДУЕМЫЙ ПЛАН ДЕЙСТВИЙ

### ВАРИАНТ A: Постепенное исправление (рекомендую)

**Фаза 1: Стабилизация CORE (1-2 дня)**

1. ✅ Исправить загрузку layouts - СДЕЛАНО
2. 🔲 Исправить сортировку по URL параметру
3. 🔲 Убедиться что базовый просмотр постов работает
4. 🔲 Убедиться что галереи работают

**Фаза 2: Упростить (1 день)**

5. 🔲 ОТКЛЮЧИТЬ chunking временно (закомментировать)
   - Chunking добавляет сложность
   - Можно использовать виртуальный скроллинг вместо него
   
6. 🔲 ОТКЛЮЧИТЬ Pages временно
   - Это продвинутая функция
   - Не нужна для базового использования

**Фаза 3: Исправить экспорт (2-3 дня)**

7. 🔲 Диагностировать PDF экспорт
8. 🔲 Диагностировать IDML экспорт
9. 🔲 Исправить найденные проблемы

**Фаза 4: Вернуть функции (по необходимости)**

10. 🔲 Вернуть chunking (если нужен)
11. 🔲 Вернуть Pages (если нужен)

---

### ВАРИАНТ B: Радикальная перестройка

Если баги слишком глубоки:

1. Создать ветку `feature/simplified`
2. Удалить:
   - Всю логику chunking
   - Систему Pages
   - Сложную логику сортировки
3. Оставить только:
   - Импорт канала
   - Просмотр постов (простой)
   - Галереи с layouts
   - PDF экспорт (базовый)
4. Постепенно добавлять функции обратно

---

## 📝 ДЕТАЛЬНЫЙ АНАЛИЗ КОДА

### Проблема с сортировкой

**Файл:** `tg-offliner-frontend/app/pages/[channelId]/posts.vue`

**Текущая логика (строки 56-64):**
```javascript
const querySortOrder = route.query.sort_order ? String(route.query.sort_order) : null
const sortOrder = ref(querySortOrder || 'desc')
```

**Затем (строки 355-363):**
```javascript
watch(channelInfo, (newChannelInfo) => {
  if (querySortOrder) return  // ← Должен предотвратить перезапись
  
  if (newChannelInfo?.changes?.sortOrder) {
    sortOrder.value = newChannelInfo.changes.sortOrder
  }
}, { immediate: true })
```

**Проблема:** `watch` с `immediate: true` срабатывает ДО того, как `channelInfo` загружен.
Когда `channelInfo` загрузится - он перезапишет `sortOrder`.

**Возможное исправление:**
```javascript
// Запомнить начальное значение
const initialSortOrder = querySortOrder || 'desc'
const sortOrder = ref(initialSortOrder)

// В watch - проверять начальное значение
watch(channelInfo, (newChannelInfo) => {
  // Если sortOrder уже установлен из URL - не перезаписывать
  if (querySortOrder) return
  // ...
})
```

Но реальная проблема глубже - конфликт между:
- URL параметрами
- Сохранёнными настройками канала
- Дефолтным значением

---

## 🧪 ТЕСТЫ ДЛЯ ПРОВЕРКИ

### Тест 1: Layout галереи
```
1. Перезагрузить http://localhost:3000/llamasass/posts
2. Найти галерею (пост с несколькими фото)
3. Проверить что layout применён (не просто grid 2x2)
4. ✅ Если layout есть - исправление работает
```

### Тест 2: Сортировка из URL
```
1. Открыть http://localhost:3000/llamasass/posts?sort_order=asc
2. Первый пост должен быть СТАРЫЙ (самая ранняя дата)
3. ❌ Если первый пост новый - баг с сортировкой
```

### Тест 3: PDF экспорт
```
1. Открыть http://localhost:5000/api/channels/llamasass/export-pdf
2. Скачается PDF файл
3. Открыть и проверить:
   - Есть ли посты?
   - Корректные ли размеры страниц?
   - Есть ли медиа?
```

---

## 📊 ТЕКУЩАЯ АРХИТЕКТУРА (для понимания)

### Загрузка постов - ТРИ ПУТИ!

```
┌─────────────────────────────────────────────────────────────┐
│                   posts.vue                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. queryChunk задан?                                       │
│     └── ДА → initialChunkPosts (SSR, chunks API)           │
│                                                             │
│  2. queryChunk НЕ задан?                                    │
│     └── allPosts (обычный /api/posts)                      │
│                                                             │
│  3. После загрузки chunksInfo:                             │
│     └── Если chunks > 1 → onChunkSelected() → chunkPosts   │
│                                                             │
│  displayPosts = chunkPosts || allPosts                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Это СЛИШКОМ СЛОЖНО.** Три разных пути загрузки = три места для багов.

### Рекомендация: Упростить до ОДНОГО пути

```
┌─────────────────────────────────────────────────────────────┐
│  Предлагаемый подход:                                       │
│                                                             │
│  1. Всегда использовать /api/posts                         │
│  2. Сортировка на бэкенде (добавить параметр sort)         │
│  3. Виртуальный скроллинг на фронте (tanstack-virtual)     │
│  4. Убрать chunks совсем                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЙ

### Для отключения chunking:

**Файл:** `posts.vue`
- Убрать `ChunkNavigation` компонент
- Убрать всю логику `chunks`
- Оставить только `allPosts`

**Файл:** `api/chunks.py`
- Можно оставить, просто не использовать

### Для исправления сортировки:

**Файл:** `posts.vue` строки 355-363
- Исправить логику инициализации `sortOrder`

**Файл:** `api/posts.py`
- Добавить параметр `sort_order`
- Сортировать посты на бэкенде

---

## ✅ ЧТО УЖЕ ИСПРАВЛЕНО

1. `api/posts.py` - добавлен layout к постам
2. `api/chunks.py` - добавлен layout к постам через chunks API
3. **API v2 создан и работает:**
   - `GET /api/v2/channels/{id}/posts` — посты с layouts, hidden states, комментариями
   - `PUT /api/v2/channels/{id}/settings` — сохранение настроек
   - `POST /api/v2/posts/{channel}/{telegram_id}/visibility` — скрытие постов
   - `GET /api/v2/channels/{id}/chunks` — метаданные chunks

---

## 🚀 СЛЕДУЮЩИЕ ШАГИ

### Фаза 1: Миграция Frontend на API v2 (следующий шаг)
1. [ ] Создать `services/apiV2.js`
2. [ ] Создать `composables/useChannelPosts.js`
3. [ ] Мигрировать `posts.vue` на API v2
4. [ ] Убрать отдельную загрузку layouts/edits
5. [ ] Добавить UI для сохранения настроек

### Фаза 2: Тестирование
1. [ ] Запустить unit тесты (`pytest tests/test_api_v2.py`)
2. [ ] E2E тесты критичных сценариев

### Фаза 3: Cleanup
1. [ ] Deprecation warnings для v1 endpoints
2. [ ] Удалить дублирующий код

