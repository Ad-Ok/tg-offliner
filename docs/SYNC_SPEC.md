# –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–¥–æ–∫–∞—á–∫–∞) –∫–∞–Ω–∞–ª–∞

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 14 —Ñ–µ–≤—Ä–∞–ª—è 2026

---

## üìã –¶–µ–ª—å

–î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–∫–∞—á–∫–∏ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–∑ Telegram –∫–∞–Ω–∞–ª–∞, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É. –í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–∏–º–ø–æ—Ä—Ç–∞ ‚Äî —Å–∫–∞—á–∏–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–æ—è–≤–∏–ª–æ—Å—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–º–ø–æ—Ä—Ç–∞/—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

---

## üéØ Scope

### –í–∫–ª—é—á–µ–Ω–æ

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| **–ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã** | –ü–æ—Å—Ç—ã —Å `telegram_id > max(telegram_id)` –≤ –ë–î |
| **–ù–æ–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ discussion group —Å `telegram_id > max` |
| **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞** | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤, –æ–ø–∏—Å–∞–Ω–∏—è, –∞–≤–∞—Ç–∞—Ä–∞ –∏ —Ç.–¥. |
| **–ú–µ–¥–∏–∞** | –ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ |
| **Gallery layouts** | –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö) |

### –ù–µ –≤–∫–ª—é—á–µ–Ω–æ (v1)

- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ—Å—Ç–∞—Ö

---

## üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π (UX Flow)

### –î–≤—É—Ö—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å: Check ‚Üí Confirm ‚Üí Sync

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞–Ω–∞–ª–∞ (ChannelsList.vue)         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  llamatest  ¬∑  17 –ø–æ—Å—Ç–æ–≤  ¬∑  24 –∫–æ–º–º.     ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [–≠–∫—Å–ø–æ—Ä—Ç ‚ñº]  [üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å]  [üóë]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ –∫–ª–∏–∫
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—Ä–æ–≤–µ—Ä–∫–∞...  ‚è≥                            ‚îÇ
‚îÇ  (GET /api/sync/check/{channel_id})         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ –æ—Ç–≤–µ—Ç
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–≤–æ–¥–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏                       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  üìä –ù–∞–π–¥–µ–Ω–æ:                               ‚îÇ
‚îÇ  ¬∑ 15 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤                          ‚îÇ
‚îÇ  ¬∑ ~30 –Ω–æ–≤—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–æ—Ü–µ–Ω–∫–∞)          ‚îÇ
‚îÇ  ¬∑ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ–¥–ø–∏—Å—á–∏–∫–∏          ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [–û—Ç–º–µ–Ω–∞]  [‚ñ∂ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å]             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë  12/15       ‚îÇ
‚îÇ  (POST /api/sync/start/{channel_id})        ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  –ü—Ä–æ–≥—Ä–µ—Å—Å: 12 –ø–æ—Å—Ç–æ–≤ ¬∑ 8 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤      ‚îÇ
‚îÇ  [‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å]                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é ‚Äî –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –Ω–∞–∂–∞—Ç–∏–∏ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å" –ø—Ä–æ—Ü–µ—Å—Å **–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ** (–Ω–æ–≤—ã–π check ‚Üí confirm ‚Üí sync). –ù–æ –ø–æ—Å–∫–æ–ª—å–∫—É —É–∂–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î, `max(telegram_id)` –±—É–¥–µ—Ç –≤—ã—à–µ ‚Üí —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –Ω–æ–≤—ã–µ.

### –°–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏

| –°–æ—Å—Ç–æ—è–Ω–∏–µ | –ö–Ω–æ–ø–∫–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|-----------|--------|----------|
| Idle | `üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å` | –ó–∞–ø—É—Å–∫ check |
| Checking | `‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...` (disabled) | ‚Äî |
| Summary shown | `‚ñ∂ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å` (–≤ –º–æ–¥–∞–ª–∫–µ/dropdown) | –ó–∞–ø—É—Å–∫ sync |
| Syncing | `‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å` | Stop sync |
| No new posts | `‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ` (fade out —á–µ—Ä–µ–∑ 3 —Å–µ–∫) | ‚Äî |

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ù–æ–≤—ã–µ backend endpoints

#### 1. `GET /api/sync/check/<channel_id>`

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.**

–ê–ª–≥–æ—Ä–∏—Ç–º:
1. –ü–æ–ª—É—á–∏—Ç—å `max(telegram_id)` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `posts` –¥–ª—è `channel_id`
2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram, –ø–æ–ª—É—á–∏—Ç—å entity
3. –ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–∞–Ω–∞–ª–µ —Å `id > max_telegram_id`  
   (–∏—Å–ø–æ–ª—å–∑—É—è Telethon: `client.get_messages(entity, min_id=max_id, limit=0)` ‚Üí `.total`)
4. –ï—Å–ª–∏ –µ—Å—Ç—å discussion group ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
5. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞, —Å—Ä–∞–≤–Ω–∏—Ç—å —Å –ë–î

**Request:**
```
GET /api/sync/check/llamatest
```

**Response:**
```json
{
  "channel_id": "llamatest",
  "status": "has_updates",
  "local": {
    "posts_count": 17,
    "comments_count": 24,
    "max_post_id": 85,
    "max_comment_id": 1250,
    "last_import_date": "2026-02-12T15:30:00"
  },
  "remote": {
    "total_messages": 32,
    "new_posts_count": 15,
    "new_posts_estimate": true,
    "discussion_group_id": 2573960761,
    "new_comments_estimate": 30
  },
  "metadata_changes": {
    "subscribers": { "old": "1,234", "new": "1,456" },
    "description": { "changed": true }
  }
}
```

**–°—Ç–∞—Ç—É—Å—ã:** `has_updates`, `up_to_date`, `error`

#### 2. `POST /api/sync/start/<channel_id>`

**–ó–∞–ø—É—Å–∫–∞–µ—Ç –¥–æ–∫–∞—á–∫—É –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤.**

–ê–ª–≥–æ—Ä–∏—Ç–º:
1. –ü–æ–ª—É—á–∏—Ç—å `max(telegram_id)` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `posts`
2. –ò—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `client.iter_messages(entity, min_id=max_id, reverse=True)`
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ ‚Äî `process_message_for_api()` + `_flush_batch()`
4. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞ –≤ –ë–î
5. –ï—Å–ª–∏ –µ—Å—Ç—å discussion group ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
6. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å gallery layouts –¥–ª—è –Ω–æ–≤—ã—Ö –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø
7. –ü—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `import_state`

**Request:**
```json
POST /api/sync/start/llamatest
{
  "export_settings": {
    "include_reposts": true,
    "include_polls": true,
    "include_discussion_comments": true
  }
}
```

**Response:**
```json
{
  "message": "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ 15 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏ 28 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤",
  "processed_posts": 15,
  "processed_comments": 28,
  "metadata_updated": true,
  "success": true
}
```

#### 3. `POST /api/sync/stop/<channel_id>`

–†–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `should_stop` / `set_status('stopped')`.

#### 4. `GET /api/download/status/<channel_id>`

–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint ‚Äî —Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.  
–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `type: "sync" | "import"` –¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π.

---

## üìä –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ¬´–Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞¬ª

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è: max(telegram_id)

```
–ë–î:      [1] [2] [3] ... [85]     ‚Üê max_id = 85
Telegram: [1] [2] [3] ... [85] [86] [87] ... [100]
                                  ‚Üë               ‚Üë
                           min_id=85          –Ω–æ–≤—ã–µ
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ max telegram_id:**
```python
# –í sync-—Ñ—É–Ω–∫—Ü–∏–∏
from models import Post
max_id = db.session.query(db.func.max(Post.telegram_id)) \
    .filter(Post.channel_id == channel_id) \
    .scalar() or 0
```

**Telethon –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö:**
```python
# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö (–±–µ–∑ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)
messages = await client.get_messages(entity, min_id=max_id, limit=0)
new_count = messages.total

# –ò—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã
for post in client.iter_messages(entity, min_id=max_id, reverse=True):
    # process...
```

### –î–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ —Å `channel_id = str(discussion_group_id)`:
```python
max_comment_id = db.session.query(db.func.max(Post.telegram_id)) \
    .filter(Post.channel_id == str(discussion_group_id)) \
    .scalar() or 0
```

---

## üìÇ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

### Backend (Python)

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `api/sync.py` | **–ù–û–í–´–ô** ‚Äî Blueprint —Å endpoints check/start/stop |
| `telegram_export.py` | –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `sync_channel()` (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏–∑ `import_channel_direct`) |
| `telegram_export.py` | –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `sync_discussion_comments()` |
| `telegram_export.py` | –ù–æ–≤–∞—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è `_get_max_telegram_id(channel_id)` |
| `app.py` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è `sync_bp` blueprint |
| `message_processing/channel_info.py` | –ù–æ–≤–∞—è `compare_channel_metadata(old, new)` –¥–ª—è diff –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö |

### Frontend (Nuxt)

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `services/apiV2.js` | –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: `checkSync()`, `startSync()`, `stopSync()` |
| `components/system/ChannelsList.vue` | –ö–Ω–æ–ø–∫–∞ ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª + —Å–≤–æ–¥–∫–∞ + –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ |
| `components/system/SyncStatus.vue` | **–ù–û–í–´–ô** ‚Äî –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ sync |
| `components/system/DownloadStatus.vue` | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `type: "sync"` (–∏–ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å) |

---

## üîß –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### `sync_channel()` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è

```python
def sync_channel(channel_id, export_settings=None):
    """
    –î–æ–∫–∞—á–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã –∫–∞–Ω–∞–ª–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å max telegram_id –∏–∑ –ë–î
    max_id = _get_max_telegram_id(channel_id)
    
    # 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram
    client = connect_to_telegram()
    entity, error = get_entity_by_username_or_id(client, channel_id)
    
    # 3. –ò—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (min_id = max_id)
    new_posts = client.iter_messages(entity, min_id=max_id, reverse=True)
    
    # 4. process_message_for_api + _flush_batch (–∫–∞–∫ –≤ import)
    batch = []
    for post in new_posts:
        if should_stop_import(channel_id):
            break
        post_data = process_message_for_api(post, channel_id, client, folder_name)
        if post_data:
            batch.append(post_data)
        if len(batch) >= BATCH_SIZE:
            _flush_batch(batch)
            batch = []
    _flush_batch(batch)
    
    # 5. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞
    _update_channel_metadata(client, entity, channel_id)
    
    # 6. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    if discussion_group_id and include_comments:
        sync_discussion_comments(client, channel_id, discussion_group_id)
    
    # 7. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å gallery layouts –¥–ª—è –Ω–æ–≤—ã—Ö –≥—Ä—É–ø–ø
    generate_gallery_layouts_for_channel(channel_id)
```

### `_update_channel_metadata()` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

```python
def _update_channel_metadata(client, entity, channel_id):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞ –≤ –ë–î (–ø–æ–¥–ø–∏—Å—á–∏–∫–∏, –æ–ø–∏—Å–∞–Ω–∏–µ, –∞–≤–∞—Ç–∞—Ä)."""
    channel_info = get_channel_info(client, entity, output_dir="downloads", folder_name=folder_name)
    
    with app.app_context():
        channel = Channel.query.get(channel_id)
        if channel:
            channel.subscribers = channel_info.get('subscribers')
            channel.description = channel_info.get('description')
            channel.posts_count = channel_info.get('posts_count')
            # –ê–≤–∞—Ç–∞—Ä: —Å–∫–∞—á–∞—Ç—å –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
            if channel_info.get('avatar') and channel_info['avatar'] != channel.avatar:
                channel.avatar = channel_info['avatar']
            db.session.commit()
```

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ù–ï –≤—ã–∑—ã–≤–∞—Ç—å `clear_downloads()`** ‚Äî –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–¥–∏–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è, –∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
2. **–ù–ï —É–¥–∞–ª—è—Ç—å/–ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞–Ω–∞–ª –≤ –ë–î** ‚Äî —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è—Ç—å
3. **`generate_gallery_layouts_for_channel()`** —É–∂–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ layouts (–∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `Layout.query.filter_by(grouped_id=...).first()`)
4. **`_flush_batch()`** –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å as-is ‚Äî –æ–Ω –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
5. **–ü—Ä–æ–≥—Ä–µ—Å—Å** ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `update_import_progress()` –∏ `should_stop_import()`

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: —á—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º

| –ü–æ–ª–µ | –û–±–Ω–æ–≤–ª—è–µ–º? | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|-----------|------------|
| `name` | ‚ùå –ù–µ—Ç | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ UI |
| `subscribers` | ‚úÖ –î–∞ | –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |
| `description` | ‚úÖ –î–∞ | –¢–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ |
| `posts_count` | ‚úÖ –î–∞ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –≤ Telegram |
| `avatar` | ‚úÖ –î–∞ | –ü–µ—Ä–µ–∫–∞—á–∞—Ç—å –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è |
| `creation_date` | ‚ùå –ù–µ—Ç | –ù–µ –º–µ–Ω—è–µ—Ç—Å—è |
| `print_settings` | ‚ùå –ù–µ—Ç | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |
| `changes` | ‚ùå –ù–µ—Ç | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |

---

## üóì –§–∞–∑—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –§–∞–∑–∞ 1: Backend ‚Äî Check endpoint

- [ ] –°–æ–∑–¥–∞—Ç—å `api/sync.py` blueprint
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `GET /api/sync/check/<channel_id>`
- [ ] –§—É–Ω–∫—Ü–∏—è `_get_max_telegram_id(channel_id)`
- [ ] –§—É–Ω–∫—Ü–∏—è `compare_channel_metadata()`
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è blueprint –≤ `app.py`
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è check endpoint

### –§–∞–∑–∞ 2: Backend ‚Äî Sync endpoint

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `sync_channel()` –≤ `telegram_export.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `sync_discussion_comments()` –≤ `telegram_export.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `_update_channel_metadata()`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `POST /api/sync/start/<channel_id>` –≤ `api/sync.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `POST /api/sync/stop/<channel_id>`
- [ ] –ü—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ `import_state` (–ø–æ–ª–µ `type: "sync"`)
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è sync endpoint

### –§–∞–∑–∞ 3: Frontend ‚Äî UI

- [ ] API —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `apiV2.js`: `checkSync()`, `startSync()`, `stopSync()`
- [ ] –ö–Ω–æ–ø–∫–∞ ¬´–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª –≤ `ChannelsList.vue`
- [ ] –°–≤–æ–¥–∫–∞ diff (–º–æ–¥–∞–ª–∫–∞ –∏–ª–∏ dropdown) —Å –∫–Ω–æ–ø–∫–æ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- [ ] `SyncStatus.vue` ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–∏–ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `DownloadStatus.vue`)
- [ ] Polling –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —á–µ—Ä–µ–∑ `GET /api/download/status/<channel_id>`
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π: checking, summary, syncing, done, no updates

### –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] `tests/test_sync.py` ‚Äî unit —Ç–µ—Å—Ç—ã sync_channel, check, helpers
- [ ] `tests/test_api_sync.py` ‚Äî API endpoint —Ç–µ—Å—Ç—ã (Flask test client)
- [ ] –†—É—á–Ω–æ–π —Ç–µ—Å—Ç –Ω–∞ `llamatest`: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç ‚Üí sync ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

---

## üß™ –¢–µ—Å—Ç—ã

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
tests/
‚îú‚îÄ‚îÄ test_sync.py          # Unit —Ç–µ—Å—Ç—ã: sync_channel, helpers, edge cases
‚îî‚îÄ‚îÄ test_api_sync.py      # API endpoint —Ç–µ—Å—Ç—ã: check, start, stop
```

### `test_sync.py` ‚Äî Unit —Ç–µ—Å—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–§—Ä–µ–π–º–≤–æ—Ä–∫:** `unittest.TestCase` + –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç `TelegramExportUnitTestCase`  
**–ü–∞—Ç—Ç–µ—Ä–Ω:** `contextlib.ExitStack` –¥–ª—è —Å—Ç–µ–∫–∞ `mock.patch`, `SimpleNamespace` –¥–ª—è Telethon –æ–±—ä–µ–∫—Ç–æ–≤

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `_get_max_telegram_id()`

```python
class TestGetMaxTelegramId(unittest.TestCase):
    """–¢–µ—Å—Ç—ã –¥–ª—è _get_max_telegram_id() ‚Äî —á–∏—Å—Ç–∞—è DB-—Ñ—É–Ω–∫—Ü–∏—è."""
    
    def setUp(self):
        self.app = Flask(__name__)
        self.app.config['TESTING'] = True
        self.app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        self.app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
        db.init_app(self.app)
        with self.app.app_context():
            db.create_all()
    
    def tearDown(self):
        with self.app.app_context():
            db.session.remove()
            db.drop_all()
```

| # | –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç | Seed data | –û–∂–∏–¥–∞–Ω–∏–µ |
|---|------|---------------|-----------|----------|
| 1 | `test_returns_max_id` | –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π max –ø–æ channel_id | Posts: id=10, 50, 85 –¥–ª—è `ch1` | `85` |
| 2 | `test_returns_zero_for_empty` | –ü—É—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ | –ù–µ—Ç –ø–æ—Å—Ç–æ–≤ | `0` |
| 3 | `test_isolates_by_channel` | –ù–µ —Å–º–µ—à–∏–≤–∞–µ—Ç –∫–∞–Ω–∞–ª—ã | `ch1`: id=100, `ch2`: id=200 | ch1‚Üí`100`, ch2‚Üí`200` |
| 4 | `test_ignores_comments` | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ max –ø–æ—Å—Ç–∞ | `ch1`: id=50; `disc_group`: id=999 | ch1‚Üí`50` |

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `sync_channel()`

```python
class TestSyncChannel(TelegramExportUnitTestCase):
    """
    –¢–µ—Å—Ç—ã sync_channel(). 
    –ü–∞—Ç—Ç–µ—Ä–Ω: ExitStack + mock –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
    """
```

**–ú–æ–∫–∞–µ–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `import_channel_direct`):**

| –§—É–Ω–∫—Ü–∏—è | Mock | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|------|----------|
| `connect_to_telegram` | `mock.patch.object(telegram_export, ...)` | Mock client |
| `get_entity_by_username_or_id` | `mock.patch("utils.entity_validation....")` | `(entity, None)` |
| `_get_max_telegram_id` | `mock.patch.object(telegram_export, ...)` | `85` |
| `process_message_for_api` | `mock.patch.object(telegram_export, ...)` | `side_effect=[...]` |
| `_flush_batch` | `mock.patch.object(telegram_export, ...)` | ‚Äî |
| `_update_channel_metadata` | `mock.patch.object(telegram_export, ...)` | ‚Äî |
| `sync_discussion_comments` | `mock.patch.object(telegram_export, ...)` | `5` |
| `generate_gallery_layouts_for_channel` | `mock.patch.object(telegram_export, ...)` | ‚Äî |
| `should_stop_import` | `mock.patch.object(telegram_export, ...)` | `False` |
| `update_import_progress` | `mock.patch.object(telegram_export, ...)` | ‚Äî |

| # | –¢–µ—Å—Ç | –°—Ü–µ–Ω–∞—Ä–∏–π | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|---|------|----------|----------|
| 1 | `test_sync_new_posts_success` | 3 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞, discussion group –µ—Å—Ç—å | `result["success"] == True`, `result["processed"] == 3`, `iter_messages` –≤—ã–∑–≤–∞–Ω —Å `min_id=85` |
| 2 | `test_sync_no_new_posts` | `iter_messages` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `[]` | `result["success"] == True`, `result["processed"] == 0` |
| 3 | `test_sync_stops_on_request` | `should_stop_import` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –ø–æ—Å–ª–µ 1-–≥–æ –ø–æ—Å—Ç–∞ | `result["stopped"] == True`, `result["processed"] == 1` |
| 4 | `test_sync_entity_not_found` | `get_entity_by_username_or_id` ‚Üí `(None, "error")` | `result["success"] == False` |
| 5 | `test_sync_calls_min_id` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `iter_messages` –≤—ã–∑–≤–∞–Ω —Å `min_id=max_id` | `mock_client.iter_messages.assert_called_with(entity, min_id=85, reverse=True)` |
| 6 | `test_sync_skips_clear_downloads` | `clear_downloads` –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è | `clear_mock.assert_not_called()` |
| 7 | `test_sync_updates_metadata` | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è | `_update_channel_metadata.assert_called_once()` |
| 8 | `test_sync_handles_discussion_comments` | Discussion group ID –µ—Å—Ç—å | `sync_discussion_comments.assert_called_once_with(client, channel_id, disc_group_id)` |
| 9 | `test_sync_no_discussion_comments_when_disabled` | `include_discussion_comments=False` | `sync_discussion_comments.assert_not_called()` |
| 10 | `test_sync_generates_gallery_layouts` | –ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã —Å grouped_id | `generate_gallery_layouts_for_channel.assert_called_once()` |
| 11 | `test_sync_with_max_id_zero` | `_get_max_telegram_id` ‚Üí `0` (–ø–µ—Ä–≤—ã–π –∏–º–ø–æ—Ä—Ç) | `iter_messages` –≤—ã–∑–≤–∞–Ω —Å `min_id=0` ‚Äî —Å–∫–∞—á–∏–≤–∞–µ—Ç –≤—Å—ë |
| 12 | `test_sync_batch_flush` | 60 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ (> BATCH_SIZE=50) | `_flush_batch` –≤—ã–∑–≤–∞–Ω –º–∏–Ω–∏–º—É–º 2 —Ä–∞–∑–∞ |

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `sync_discussion_comments()`

| # | –¢–µ—Å—Ç | –°—Ü–µ–Ω–∞—Ä–∏–π | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|---|------|----------|----------|
| 1 | `test_sync_comments_success` | 5 –Ω–æ–≤—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `5` |
| 2 | `test_sync_comments_uses_min_id` | max_comment_id=1000 | `iter_messages` –≤—ã–∑–≤–∞–Ω —Å `min_id=1000` |
| 3 | `test_sync_comments_empty` | –ù–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0` |
| 4 | `test_sync_comments_entity_error` | Discussion group –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0`, –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π |

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `_update_channel_metadata()`

| # | –¢–µ—Å—Ç | –°—Ü–µ–Ω–∞—Ä–∏–π | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|---|------|----------|----------|
| 1 | `test_updates_subscribers` | –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å | `channel.subscribers == "200"` |
| 2 | `test_updates_description` | –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å | `channel.description == "new desc"` |
| 3 | `test_preserves_name` | –ò–º—è –∫–∞–Ω–∞–ª–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è | `channel.name == "old name"` (–Ω–µ –∏–∑ Telegram) |
| 4 | `test_preserves_print_settings` | print_settings –Ω–µ —Ç—Ä–æ–≥–∞—é—Ç—Å—è | `channel.print_settings` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| 5 | `test_updates_avatar` | –ê–≤–∞—Ç–∞—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è | `channel.avatar == "new_path"` |

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `compare_channel_metadata()`

| # | –¢–µ—Å—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|---|------|----------|
| 1 | `test_detects_subscriber_change` | `{"subscribers": {"old": "100", "new": "200"}}` |
| 2 | `test_detects_description_change` | `{"description": {"changed": True}}` |
| 3 | `test_no_changes` | `{}` (–ø—É—Å—Ç–æ–π dict) |
| 4 | `test_ignores_unchanged_fields` | –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –ø–æ–ª—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ |
| 5 | `test_handles_none_values` | old=None, new="value" ‚Üí —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ |

### `test_api_sync.py` ‚Äî API endpoint —Ç–µ—Å—Ç—ã

**–§—Ä–µ–π–º–≤–æ—Ä–∫:** `pytest` + fixtures  
**–ü–∞—Ç—Ç–µ—Ä–Ω:** Flask test client, in-memory SQLite, mock Telegram

#### Fixtures

```python
@pytest.fixture
def app():
    """Flask app —Å in-memory SQLite –∏ sync blueprint."""
    app = create_app()
    app.config['TESTING'] = True
    app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
    
    from api.sync import sync_bp
    app.register_blueprint(sync_bp, url_prefix='/api')
    
    with app.app_context():
        init_db(app)
        db.create_all()
        # Seed: –∫–∞–Ω–∞–ª + –ø–æ—Å—Ç—ã
        channel = Channel(id='llamatest', name='Test', subscribers='100',
                         description='Old desc', discussion_group_id=2573960761)
        db.session.add(channel)
        for i in [10, 20, 30, 40, 50]:
            db.session.add(Post(telegram_id=i, channel_id='llamatest',
                               date='2026-01-01', message=f'Post {i}'))
        db.session.commit()
        yield app
        db.session.remove()
        db.drop_all()

@pytest.fixture
def client(app):
    return app.test_client()

@pytest.fixture
def mock_telegram():
    """Mock Telegram client + entity –¥–ª—è –≤—Å–µ—Ö sync —Ç–µ—Å—Ç–æ–≤."""
    with ExitStack() as stack:
        entity = SimpleNamespace(username='llamatest', id=42, count=60)
        mock_client = mock.Mock()
        
        stack.enter_context(mock.patch(
            'api.sync.connect_to_telegram', return_value=mock_client))
        stack.enter_context(mock.patch(
            'api.sync.get_entity_by_username_or_id', return_value=(entity, None)))
        
        yield mock_client, entity
```

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `GET /api/sync/check/<channel_id>`

```python
class TestSyncCheck:
```

| # | –¢–µ—Å—Ç | –°—Ü–µ–Ω–∞—Ä–∏–π | Mock | –û–∂–∏–¥–∞–Ω–∏–µ |
|---|------|----------|------|----------|
| 1 | `test_check_has_updates` | 10 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ | `get_messages(min_id=50, limit=0).total = 10` | 200, `status: "has_updates"`, `new_posts_count: 10` |
| 2 | `test_check_up_to_date` | –ù–µ—Ç –Ω–æ–≤—ã—Ö | `.total = 0` | 200, `status: "up_to_date"`, `new_posts_count: 0` |
| 3 | `test_check_channel_not_found` | channel_id –Ω–µ –≤ –ë–î | ‚Äî | 404 |
| 4 | `test_check_telegram_error` | `get_entity_by_username_or_id` ‚Üí `(None, "error")` | ‚Äî | 503 |
| 5 | `test_check_returns_local_stats` | –ü—Ä–æ–≤–µ—Ä—è–µ–º `local` –≤ response | ‚Äî | `posts_count: 5`, `max_post_id: 50` |
| 6 | `test_check_metadata_changes` | –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å | entity + full_chat mock | `metadata_changes.subscribers` present |
| 7 | `test_check_concurrent_operation` | `import_state` —É–∂–µ `downloading` | `set_status('llamatest', 'downloading')` | 409 |
| 8 | `test_check_comments_estimate` | Discussion group, 20 –Ω–æ–≤—ã—Ö | `get_messages(disc_entity, min_id=...).total = 20` | `new_comments_estimate: 20` |

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `POST /api/sync/start/<channel_id>`

```python
class TestSyncStart:
```

| # | –¢–µ—Å—Ç | –°—Ü–µ–Ω–∞—Ä–∏–π | Mock | –û–∂–∏–¥–∞–Ω–∏–µ |
|---|------|----------|------|----------|
| 1 | `test_start_success` | 3 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞ | `sync_channel` ‚Üí success dict | 200, `processed_posts: 3` |
| 2 | `test_start_channel_not_found` | –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–∞–Ω–∞–ª | ‚Äî | 404 |
| 3 | `test_start_concurrent` | –£–∂–µ –∏–¥—ë—Ç sync/import | `set_status(downloading)` | 409 |
| 4 | `test_start_with_export_settings` | –ö–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ body | ‚Äî | `sync_channel` –≤—ã–∑–≤–∞–Ω —Å settings |
| 5 | `test_start_sets_status` | –ü—Ä–æ–≤–µ—Ä–∫–∞ `import_state` | ‚Äî | `get_status()["type"] == "sync"` |
| 6 | `test_start_telegram_error` | Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | `sync_channel` ‚Üí error | 503 |

#### –¢–µ—Å—Ç-–∫–µ–π—Å—ã: `POST /api/sync/stop/<channel_id>`

```python
class TestSyncStop:
```

| # | –¢–µ—Å—Ç | –°—Ü–µ–Ω–∞—Ä–∏–π | –û–∂–∏–¥–∞–Ω–∏–µ |
|---|------|----------|----------|
| 1 | `test_stop_active_sync` | –°—Ç–∞—Ç—É—Å `downloading` —Å `type: sync` | 200, —Å—Ç–∞—Ç—É—Å ‚Üí `stopped` |
| 2 | `test_stop_no_active_sync` | –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ | 404 |
| 3 | `test_stop_already_stopped` | –°—Ç–∞—Ç—É—Å `stopped` | 400 |

### –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Ç–µ—Å—Ç–æ–≤

#### Unit —Ç–µ—Å—Ç: `sync_channel` success

```python
def test_sync_new_posts_success(self):
    """sync_channel —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã (min_id > max_id)."""
    entity = SimpleNamespace(username="llamatest", id=42, count=100)
    mock_client = mock.Mock()
    
    # 3 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞ (telegram_id > 85)
    new_posts = [
        self._build_basic_post(id=86, message="New 1"),
        self._build_basic_post(id=87, message="New 2"),
        self._build_basic_post(id=88, message="New 3"),
    ]
    mock_client.iter_messages.return_value = new_posts
    
    with ExitStack() as stack:
        stack.enter_context(mock.patch.object(
            telegram_export, "connect_to_telegram", return_value=mock_client))
        stack.enter_context(mock.patch(
            "utils.entity_validation.get_entity_by_username_or_id",
            return_value=(entity, None)))
        stack.enter_context(mock.patch.object(
            telegram_export, "_get_max_telegram_id", return_value=85))
        pma_mock = stack.enter_context(mock.patch.object(
            telegram_export, "process_message_for_api",
            side_effect=[
                {"telegram_id": 86, "channel_id": "llamatest", "date": "2026-02-15"},
                {"telegram_id": 87, "channel_id": "llamatest", "date": "2026-02-15"},
                {"telegram_id": 88, "channel_id": "llamatest", "date": "2026-02-15"},
            ]))
        flush_mock = stack.enter_context(mock.patch.object(
            telegram_export, "_flush_batch"))
        stack.enter_context(mock.patch.object(
            telegram_export, "_update_channel_metadata"))
        stack.enter_context(mock.patch.object(
            telegram_export, "sync_discussion_comments", return_value=5))
        stack.enter_context(mock.patch.object(
            telegram_export, "generate_gallery_layouts_for_channel"))
        stack.enter_context(mock.patch.object(
            telegram_export, "should_stop_import", return_value=False))
        stack.enter_context(mock.patch.object(
            telegram_export, "update_import_progress"))
        
        result = telegram_export.sync_channel("llamatest")
    
    self.assertTrue(result["success"])
    self.assertEqual(result["processed"], 3)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ iter_messages –≤—ã–∑–≤–∞–Ω —Å min_id
    mock_client.iter_messages.assert_called_once_with(
        entity, min_id=85, reverse=True)
```

#### API —Ç–µ—Å—Ç: check endpoint

```python
class TestSyncCheck:
    def test_check_has_updates(self, client, mock_telegram):
        mock_client, entity = mock_telegram
        
        # Telegram –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ 10 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤
        messages_result = mock.Mock()
        messages_result.total = 10
        mock_client.get_messages.return_value = messages_result
        
        response = client.get('/api/sync/check/llamatest')
        
        assert response.status_code == 200
        data = response.get_json()
        assert data['status'] == 'has_updates'
        assert data['remote']['new_posts_count'] == 10
        assert data['local']['max_post_id'] == 50
        assert data['local']['posts_count'] == 5

    def test_check_channel_not_in_db(self, client, mock_telegram):
        response = client.get('/api/sync/check/nonexistent')
        assert response.status_code == 404

    def test_check_up_to_date(self, client, mock_telegram):
        mock_client, _ = mock_telegram
        messages_result = mock.Mock()
        messages_result.total = 0
        mock_client.get_messages.return_value = messages_result
        
        response = client.get('/api/sync/check/llamatest')
        
        assert response.status_code == 200
        data = response.get_json()
        assert data['status'] == 'up_to_date'
```

### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Ç–µ—Å—Ç–æ–≤

| –§–∞–π–ª | –ö–ª–∞—Å—Å | –ö–æ–ª-–≤–æ —Ç–µ—Å—Ç–æ–≤ | –°—Ç–∏–ª—å |
|------|-------|---------------|-------|
| `test_sync.py` | `TestGetMaxTelegramId` | 4 | unittest + in-memory DB |
| `test_sync.py` | `TestSyncChannel` | 12 | unittest + ExitStack mocks |
| `test_sync.py` | `TestSyncDiscussionComments` | 4 | unittest + ExitStack mocks |
| `test_sync.py` | `TestUpdateChannelMetadata` | 5 | unittest + in-memory DB |
| `test_sync.py` | `TestCompareChannelMetadata` | 5 | unittest (—á–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è) |
| `test_api_sync.py` | `TestSyncCheck` | 8 | pytest + Flask test client |
| `test_api_sync.py` | `TestSyncStart` | 6 | pytest + Flask test client |
| `test_api_sync.py` | `TestSyncStop` | 3 | pytest + Flask test client |
| | | **–ò—Ç–æ–≥–æ: 47** | |

---

## ‚ö†Ô∏è Edge cases

| –°–∏—Ç—É–∞—Ü–∏—è | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|----------|----------|
| –ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î | 404 ‚Äî "–ö–∞–Ω–∞–ª –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω" |
| –ù–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ | `status: "up_to_date"` ‚Üí –∫–Ω–æ–ø–∫–∞ "‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ" |
| Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | 503 ‚Äî "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram" |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç/—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | 409 ‚Äî "–û–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è" (–ø—Ä–æ–≤–µ—Ä—è—Ç—å `import_state`) |
| –ö–∞–Ω–∞–ª —Å—Ç–∞–ª –ø—Ä–∏–≤–∞—Ç–Ω—ã–º | 403 ‚Äî "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É" |
| Discussion group –∏–∑–º–µ–Ω–∏–ª–∞—Å—å | –û–±–Ω–æ–≤–∏—Ç—å `discussion_group_id` –≤ –ë–î |
| –ü–æ—Å—Ç—ã —Å `grouped_id` (–∞–ª—å–±–æ–º—ã) | –í—Å–µ —á–∞—Å—Ç–∏ –∞–ª—å–±–æ–º–∞ –ø–æ–ø–∞–¥—É—Ç –ø–æ `min_id`, layout –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| –ü—É—Å—Ç–æ–π –∫–∞–Ω–∞–ª (0 –ø–æ—Å—Ç–æ–≤ –≤ –ë–î) | `max_id = 0` ‚Üí —Å–∫–∞—á–∞—Ç—å –≤—Å–µ (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –ø–æ–ª–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞) |
| Sync –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ import | `max_id` —É—á–∏—Ç—ã–≤–∞–µ—Ç —É–∂–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã ‚Üí –¥–æ–∫–∞—á–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ |

---

## üìö –ü—Ä–∏–º–µ—Ä—ã API

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–Ω–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

```
GET /api/sync/check/llamatest

200 OK
{
  "channel_id": "llamatest",
  "status": "up_to_date",
  "local": {
    "posts_count": 17,
    "comments_count": 24,
    "max_post_id": 85
  },
  "remote": {
    "total_messages": 17,
    "new_posts_count": 0,
    "new_comments_estimate": 0
  },
  "metadata_changes": {}
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ (–µ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

```
GET /api/sync/check/llamatest

200 OK
{
  "channel_id": "llamatest",
  "status": "has_updates",
  "local": {
    "posts_count": 17,
    "comments_count": 24,
    "max_post_id": 85
  },
  "remote": {
    "total_messages": 32,
    "new_posts_count": 15,
    "new_comments_estimate": 30
  },
  "metadata_changes": {
    "subscribers": { "old": "150", "new": "200" }
  }
}
```

### –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```
POST /api/sync/start/llamatest
Content-Type: application/json

{
  "export_settings": {
    "include_reposts": true,
    "include_polls": true,
    "include_discussion_comments": true
  }
}

200 OK
{
  "success": true,
  "processed_posts": 15,
  "processed_comments": 28,
  "metadata_updated": true,
  "message": "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ 15 –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏ 28 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤"
}
```

### –ü—Ä–æ–≥—Ä–µ—Å—Å (—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint)

```
GET /api/download/status/llamatest

200 OK
{
  "status": "downloading",
  "type": "sync",
  "details": {
    "processed_posts": 8,
    "total_posts": 15,
    "processed_comments": 3,
    "started_at": 1739520000
  }
}
```
