# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞ –∫–∞–Ω–∞–ª–æ–≤

> **–î–∞—Ç–∞:** 13 —Ñ–µ–≤—Ä–∞–ª—è 2026
> **–°—Ç–∞—Ç—É—Å:** P0 + P1 (—á–∞—Å—Ç–∏—á–Ω–æ) + P2 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã. –û—Å—Ç–∞–ª–æ—Å—å: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞.

---

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–º–ø–æ—Ä—Ç–∞ (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

### –û–±—â–∏–π —Ñ–ª–æ—É

```
Frontend ‚Üí POST /api/download/import ‚Üí background thread ‚Üí telegram_export.py
```

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

```
1. connect_to_telegram()                          ‚Äî singleton Telethon client
2. get_channel_info() ‚Üí _save_channel()           ‚Äî –ø—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å –≤ –ë–î (–±–µ–∑ HTTP)
3. client.iter_messages(entity, reverse=True)      ‚Äî –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
4. –ù–∞ –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç:
   ‚îú‚îÄ‚îÄ process_message_for_api()                   ‚Äî —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞, thumbnail, –ø–∞—Ä—Å–∏–Ω–≥
   ‚îú‚îÄ‚îÄ batch.append(post_data)                     ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤ batch (BATCH_SIZE=50)
   ‚îú‚îÄ‚îÄ _flush_batch() –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏               ‚Äî –æ–¥–∏–Ω db.session.commit() –Ω–∞ 50 –ø–æ—Å—Ç–æ–≤
   ‚îú‚îÄ‚îÄ should_stop_import() ‚Üí import_state         ‚Äî —á—Ç–µ–Ω–∏–µ –∏–∑ –ø–∞–º—è—Ç–∏ (0ns, –±–µ–∑ HTTP)
   ‚îî‚îÄ‚îÄ update_import_progress() ‚Üí import_state     ‚Äî –∑–∞–ø–∏—Å—å –≤ –ø–∞–º—è—Ç—å –∫–∞–∂–¥—ã–µ 5 –ø–æ—Å—Ç–æ–≤
5. import_all_discussion_comments()                ‚Äî streaming (1 –ø—Ä–æ—Ö–æ–¥, reverse=True)
6. generate_gallery_layouts_for_channel()           ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è layouts
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

–§—É–Ω–∫—Ü–∏—è `import_all_discussion_comments()` ‚Äî **streaming, –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥ —Å `reverse=True`**:

```python
# –û–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥: —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏ ‚Üí forwards –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –î–û –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
reverse_mapping = {}   # forwarded_msg_id ‚Üí original_post_id (O(1) lookup)
pending = []           # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö forward –µ—â—ë –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª—Å—è
batch = []

for message in client.iter_messages(discussion_entity, reverse=True):
    if message.fwd_from and message.fwd_from.saved_from_msg_id:
        reverse_mapping[message.id] = message.fwd_from.saved_from_msg_id  # O(1)
        continue
    
    if is_comment(message):
        original_post_id = reverse_mapping.get(top_id)  # O(1) –≤–º–µ—Å—Ç–æ O(K)
        if original_post_id:
            batch.append(comment_data)
        else:
            pending.append(message)  # –î–ª—è —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞–µ–≤

# –û–±—Ä–∞–±–æ—Ç–∫–∞ pending ‚Äî —Ç–µ–ø–µ—Ä—å –≤—Å–µ forwards —Å–æ–±—Ä–∞–Ω—ã
for message in pending:
    original_post_id = reverse_mapping.get(...)
    ...

_flush_batch(batch)  # –û–¥–∏–Ω commit –Ω–∞ –≤—Å—é –ø–∞—á–∫—É
```

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –†–æ–ª—å |
|------|------|
| `telegram_export.py` | –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞, `_flush_batch()`, `_save_channel()` |
| `utils/import_state.py` | **–ù–æ–≤—ã–π** ‚Äî thread-safe shared state –¥–ª—è stop/progress |
| `message_processing/message_transform.py` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞, thumbnail, –ø–∞—Ä—Å–∏–Ω–≥ |
| `message_processing/author.py` | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞ (–º–æ–∂–µ—Ç —Å–∫–∞—á–∏–≤–∞—Ç—å –∞–≤–∞—Ç–∞—Ä) |
| `api/downloads.py` | Endpoints –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—á–∏—Ç–∞–µ—Ç –∏–∑ `import_state`) |
| `app.py` | Backward-compatible wrappers, –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ `import_state` |
| `config.py` | `EXPORT_SETTINGS` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–º–ø–æ—Ä—Ç–∞ |

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### P0 ‚Äî –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç

#### 1. ‚úÖ –£–±—Ä–∞–Ω `time.sleep(0.1)`

**–≠–∫–æ–Ω–æ–º–∏—è:** ~50s –Ω–∞ 500 –ø–æ—Å—Ç–æ–≤

–ó–∞–¥–µ—Ä–∂–∫–∞ –±—ã–ª–∞ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞ ‚Äî Telethon —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç rate limiting —á–µ—Ä–µ–∑ `FloodWaitError`. `iter_messages` –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–∞—á–∫–∞–º–∏ ‚Äî –º–µ–∂–¥—É –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞.

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** —É–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `time.sleep(0.1)` –∏–∑ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å—Ç–æ–≤ –≤ `telegram_export.py`.

#### 2. ‚úÖ Batch INSERT –≤–º–µ—Å—Ç–æ HTTP POST –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç

**–≠–∫–æ–Ω–æ–º–∏—è:** ~5s ‚Üí ~0.05s (√ó100)

–í–º–µ—Å—Ç–æ HTTP –∑–∞–ø—Ä–æ—Å–∞ `requests.post("/api/posts")` –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç ‚Äî –ø—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å –≤ –ë–î –ø–∞—á–∫–∞–º–∏ —á–µ—Ä–µ–∑ `_flush_batch()`:

- `BATCH_SIZE = 50` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –≤ –æ–¥–Ω–æ–º –∫–æ–º–º–∏—Ç–µ
- `_flush_batch(batch)` ‚Äî —Å–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç—ã `Post`, –¥–µ–ª–∞–µ—Ç –æ–¥–∏–Ω `db.session.commit()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ –ø–æ—Å—Ç–æ–≤, –∏ –≤ `import_all_discussion_comments()`

#### 2b. ‚úÖ `_save_channel()` ‚Äî –ø—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å –∫–∞–Ω–∞–ª–∞ –≤ –ë–î

–í–º–µ—Å—Ç–æ `requests.post("/api/channels")` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è `_save_channel(channel_info)` –ø–∏—à–µ—Ç –≤ –ë–î –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ SQLAlchemy. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –∏ discussion group.

---

### P1 ‚Äî –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ (—á–∞—Å—Ç–∏—á–Ω–æ)

#### 3. ‚úÖ Reverse mapping O(1) –≤–º–µ—Å—Ç–æ O(K)

`reverse_mapping[msg_id] ‚Üí original_post_id` ‚Äî dict lookup –≤–º–µ—Å—Ç–æ –ª–∏–Ω–µ–π–Ω–æ–≥–æ –ø–µ—Ä–µ–±–æ—Ä–∞ `forward_mapping.items()`. –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –¥–ª—è –≥—Ä—É–ø–ø —Å 10k+ —Å–æ–æ–±—â–µ–Ω–∏–π.

#### 4. ‚úÖ Streaming –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (1 –ø—Ä–æ—Ö–æ–¥)

`import_all_discussion_comments()` —Ç–µ–ø–µ—Ä—å:
- **–û–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥** —Å `reverse=True` (—Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏)
- Forwards –∏–∑ –∫–∞–Ω–∞–ª–∞ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ä–∞–Ω—å—à–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ ‚Üí –º–∏–Ω–∏–º—É–º pending
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ RAM
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `_flush_batch()` –¥–ª—è –∑–∞–ø–∏—Å–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

#### 5. ‚ùå –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ ‚Äî –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

**–≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –Ω–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –≥–ª–∞–≤–Ω—ã–π –æ—Å—Ç–∞–≤—à–∏–π—Å—è bottleneck.**

–ú–µ–¥–∏–∞ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤ `process_message_for_api()` ‚Üí `client.download_media()`. –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª 0.5-5 —Å–µ–∫—É–Ω–¥. –î–ª—è 100 —Ñ–æ—Ç–æ = ~200—Å.

–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ —Å–µ–∫—Ü–∏–∏ ¬´–ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏¬ª –Ω–∏–∂–µ.

---

### P2 ‚Äî –ß–∏—Å—Ç–∫–∞

#### 6. ‚úÖ Shared state –≤–º–µ—Å—Ç–æ HTTP –¥–ª—è stop/progress

**`utils/import_state.py`** ‚Äî thread-safe –º–æ–¥—É–ª—å —Å `threading.Lock`:
- `set_status(channel_id, status, details)` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- `get_status(channel_id)` ‚Äî —á—Ç–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- `should_stop(channel_id)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (0ns vs 5ms HTTP)
- `update_progress(channel_id, ...)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- `clear_status(channel_id)` ‚Äî –æ—á–∏—Å—Ç–∫–∞

**`telegram_export.py`** —á–∏—Ç–∞–µ—Ç stop/progress –∏–∑ –ø–∞–º—è—Ç–∏:
```python
from utils.import_state import should_stop as _state_should_stop, update_progress as _state_update_progress
```

**`api/downloads.py`** ‚Äî REST endpoints —á–∏—Ç–∞—é—Ç/–ø–∏—à—É—Ç —Ç–æ—Ç –∂–µ shared state:
```python
from utils.import_state import get_all_statuses, get_status, set_status, ...
```

**`app.py`** ‚Äî backward-compatible wrappers –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç –≤ `import_state`.

---

## üê¢ –û—Å—Ç–∞–≤—à–∏–µ—Å—è —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –í–ª–∏—è–Ω–∏–µ | –ì–¥–µ |
|---|----------|---------|-----|
| **1** | **–ú–µ–¥–∏–∞ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ** | 0.5-5s √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–¥–∏–∞ = **–æ—Å–Ω–æ–≤–Ω–æ–π bottleneck** | `message_transform.py`: `client.download_media()` |
| **2** | **Thumbnail —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ** | ~50ms √ó —Ñ–æ—Ç–æ | `message_transform.py`: Pillow resize |

### –†–∞—Å—á—ë—Ç –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**500 –ø–æ—Å—Ç–æ–≤, 200 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, 100 —Ñ–æ—Ç–æ, discussion group 5000 —Å–æ–æ–±—â–µ–Ω–∏–π:**

```
–ü–û–°–¢–´:
  500 √ó 0s    (sleep —É–±—Ä–∞–Ω)        = 0s
  50 √ó 0.001s (batch commit)       = 0.05s
  100 √ó 2.0s  (media download)     = 200.0s       ‚Üê –ì–õ–ê–í–ù–´–ô BOTTLENECK
  100 √ó 0.05s (thumbnail)          = 5.0s
  500 √ó 0ns   (shared state stop)  = 0s
  100 √ó 0ns   (shared state progress) = 0s
                              –ò–¢–û–ì–û ‚âà 205s (3.4 –º–∏–Ω)

–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò:
  5000 —Å–æ–æ–±—â–µ–Ω–∏–π √ó Telegram API    ‚âà 30-60s (iter_messages, 1 –ø—Ä–æ—Ö–æ–¥)
  4 √ó 0.001s  (batch commit)       = 0.004s
  200 √ó O(1)  (reverse_mapping)    ‚âà 0s
                              –ò–¢–û–ì–û ‚âà 30-60s

LAYOUTS:
  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è                        ‚âà 2-5s

–û–ë–©–ï–ï –í–†–ï–ú–Ø: ~4-5 –º–∏–Ω—É—Ç (vs ~5-6 –º–∏–Ω—É—Ç –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
```

**–û—Å–Ω–æ–≤–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:** ~60s –Ω–∞ sleep + HTTP overhead. –ú–µ–¥–∏–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç.

---

## üîÆ –ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ (—Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç)

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:** 200s ‚Üí 30-50s (√ó4-6)

**–í–∞—Ä–∏–∞–Ω—Ç A: –î–≤—É—Ö—Ñ–∞–∑–Ω—ã–π –∏–º–ø–æ—Ä—Ç (–ø—Ä–æ—â–µ)**

```python
# –§–∞–∑–∞ 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ—Å—Ç—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ë–î
# –§–∞–∑–∞ 2: –°–∫–∞—á–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å–∏

import asyncio

async def download_media_batch(client, posts_with_media, channel_folder):
    """–°–∫–∞—á–∏–≤–∞–µ—Ç –º–µ–¥–∏–∞ –¥–ª—è –ø–∞—á–∫–∏ –ø–æ—Å—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ."""
    semaphore = asyncio.Semaphore(4)  # –ú–∞–∫—Å–∏–º—É–º 4 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–∫–∏
    
    async def download_one(post):
        async with semaphore:
            target = os.path.join(channel_folder, "media", f"{post.id}_media")
            path = await client.download_media(post.media, file=target)
            return post.id, path
    
    tasks = [download_one(post) for post in posts_with_media]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    return results
```

**–í–∞—Ä–∏–∞–Ω—Ç B: Async Telethon (–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥)**

Telethon ‚Äî async –±–∏–±–ª–∏–æ—Ç–µ–∫–∞. –¢–µ–∫—É—â–∏–π –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `telethon.sync` –æ–±—ë—Ä—Ç–∫—É. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—ã–π async –¥–∞—ë—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞.

**–û—Å—Ç–æ—Ä–æ–∂–Ω–æ:** `telethon.sync` client –Ω–µ thread-safe. –î–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω –ª–∏–±–æ –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ async, –ª–∏–±–æ –ø—É–ª Telethon –∫–ª–∏–µ–Ω—Ç–æ–≤.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç A (–¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π) ‚Äî –ø—Ä–æ—â–µ, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ –Ω–∞ async.

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| # | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –≠—Ñ—Ñ–µ–∫—Ç |
|---|-------------|--------|--------|
| 1 | –£–±—Ä–∞—Ç—å `sleep(0.1)` | ‚úÖ –ì–æ—Ç–æ–≤–æ | **-50s / 500 –ø–æ—Å—Ç–æ–≤** |
| 2 | Batch INSERT –≤ –ë–î | ‚úÖ –ì–æ—Ç–æ–≤–æ | **-5s**, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å |
| 2b | `_save_channel()` –ø—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å | ‚úÖ –ì–æ—Ç–æ–≤–æ | -HTTP overhead |
| 3 | Reverse mapping O(1) | ‚úÖ –ì–æ—Ç–æ–≤–æ | O(1) –≤–º–µ—Å—Ç–æ O(K) |
| 4 | Streaming –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (1 –ø—Ä–æ—Ö–æ–¥) | ‚úÖ –ì–æ—Ç–æ–≤–æ | **-RAM**, -1 –ø—Ä–æ—Ö–æ–¥ API |
| 5 | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ | ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | **-150s / 100 —Ñ–æ—Ç–æ** |
| 6 | Shared state –≤–º–µ—Å—Ç–æ HTTP | ‚úÖ –ì–æ—Ç–æ–≤–æ | -3s, —á–∏—Å—Ç–æ—Ç–∞ |

### –¢–µ–∫—É—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç

```
–î–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (500 –ø–æ—Å—Ç–æ–≤, 100 —Ñ–æ—Ç–æ, 200 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤):  ~5-6 –º–∏–Ω—É—Ç
–ü–û–°–õ–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (P0 + P1 —á–∞—Å—Ç–∏—á–Ω–æ + P2):                 ~4-5 –º–∏–Ω—É—Ç

–° –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–´–ú –ú–ï–î–ò–ê (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å):                    ~1-1.5 –º–∏–Ω—É—Ç—ã
```

---

## üìã –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ |
|------|-------------|
| `utils/import_state.py` | **–ù–æ–≤—ã–π** ‚Äî thread-safe shared state –¥–ª—è stop/progress |
| `telegram_export.py` | P0: —É–±—Ä–∞–Ω sleep, batch insert, `_save_channel()`. P1: streaming comments, reverse mapping. P2: shared state |
| `app.py` | P2: backward-compatible wrappers –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç –≤ `import_state` |
| `api/downloads.py` | P2: —á–∏—Ç–∞–µ—Ç/–ø–∏—à–µ—Ç `import_state` –Ω–∞–ø—Ä—è–º—É—é |

### Legacy –∫–æ–¥

–°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è `import_discussion_comments()` (–æ–¥–Ω–æ–ø–æ—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è) –≤—Å—ë –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `requests.post()`. –û–Ω–∞ **–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–ª–æ—É –∏–º–ø–æ—Ä—Ç–∞** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `import_all_discussion_comments()`), –Ω–æ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –∫–æ–¥–µ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. `import requests` –≤ `telegram_export.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —ç—Ç–æ–π legacy —Ñ—É–Ω–∫—Ü–∏–µ–π.

---

## üìã –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ (–¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∏–ª–∏ async Telethon)
- [ ] –£–¥–∞–ª–∏—Ç—å legacy `import_discussion_comments()` –∏ `import requests`
- [ ] –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—ã–π async Telethon (–±–æ–ª—å—à–æ–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥)
